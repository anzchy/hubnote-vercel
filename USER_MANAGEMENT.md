# 用户管理功能说明

## 概述

HubNote 现在支持用户白名单管理功能，可以控制哪些用户可以访问系统，防止未授权访问。

## 功能特性

### 用户角色

- **普通用户**: 可以登录系统，管理自己的 GitHub 仓库和 Issues
- **管理员**: 除普通用户权限外，还可以管理用户白名单

### 安全机制

- **白名单控制**: 只有在白名单中的用户才能登录系统
- **管理员权限**: 只有管理员可以添加/删除用户
- **自我保护**: 管理员不能删除自己的账户

## 使用方法

### 1. 初始化第一个管理员

在首次部署后，需要设置第一个管理员用户：

```bash
# 运行初始化脚本
python init_admin.py

# 查看当前白名单状态
python init_admin.py --show
```

按提示输入要设置为管理员的 GitHub 用户名。

### 2. 管理员登录

1. 访问系统登录页面
2. 输入 GitHub 用户名和 Personal Access Token
3. 登录成功后，导航栏会显示 "用户管理" 链接

### 3. 管理用户白名单

管理员可以通过 "用户管理" 页面：

- **添加用户**: 输入 GitHub 用户名，选择是否为管理员
- **删除用户**: 从白名单中移除用户
- **查看权限**: 查看所有用户的权限级别

## 权限说明

### 访问控制逻辑

1. **白名单为空**: 所有用户都可以访问（向后兼容）
2. **白名单不为空**: 只有白名单中的用户可以访问
3. **管理员权限**: 只有管理员可以访问用户管理功能

### GitHub Token 要求

用户的 Personal Access Token 需要以下权限：
- `repo`: 访问仓库
- `read:user`: 读取用户信息

## 安全最佳实践

### 1. 管理员账户安全

- 确保管理员的 GitHub 账户安全
- 定期更新 Personal Access Token
- 不要共享管理员凭据

### 2. 用户管理

- 定期审查用户白名单
- 及时移除不再需要访问的用户
- 谨慎授予管理员权限

### 3. 部署安全

- 在生产环境中立即设置用户白名单
- 不要在公开环境中运行没有访问控制的系统

## 故障排除

### 常见问题

**Q: 忘记设置管理员，无法访问用户管理功能？**
A: 运行 `python init_admin.py` 重新设置管理员

**Q: 用户显示"没有访问权限"？**
A: 检查用户是否在白名单中，联系管理员添加

**Q: 管理员无法删除某个用户？**
A: 管理员不能删除自己的账户，这是安全保护机制

**Q: 白名单数据丢失？**
A: 检查存储配置，重新运行初始化脚本

### 调试信息

查看当前白名单状态：
```bash
python init_admin.py --show
```

检查存储类型：
```python
from utils.storage import StorageManager
storage = StorageManager()
print(f"存储类型: {storage.storage_type}")
print(f"白名单: {storage.get_user_whitelist()}")
```

## API 接口

### 用户管理相关路由

- `GET /user-management`: 用户管理页面（仅管理员）
- `POST /add-user`: 添加用户到白名单（仅管理员）
- `POST /remove-user`: 从白名单移除用户（仅管理员）

### 认证检查

系统会在以下时机检查用户权限：
1. 用户登录时检查是否在白名单中
2. 访问用户管理功能时检查管理员权限
3. 执行用户管理操作时验证权限

## 数据存储

用户白名单数据存储在：
- **Vercel KV**: 生产环境推荐
- **内存存储**: 开发环境临时方案
- **文件存储**: 本地开发环境

数据格式：
```json
{
  "allowed_users": ["user1", "user2"],
  "admin_users": ["admin1"]
}
```

## 更新日志

- 添加用户白名单功能
- 支持管理员权限管理
- 提供初始化脚本
- 增加安全检查机制